<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>AO Wallet Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: #fafafa;
      color: #2c2c2c;
      line-height: 1.5;
    }
    
    .container {
      max-width: 100vw;
      margin: 0 auto;
      padding: 20px;
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    .sidebar {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #e5e5e5;
      height: calc(100vh - 40px);
      position: sticky;
      top: 20px;
      overflow: hidden;
    }
    
    .main-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
      border: 1px solid #e5e5e5;
      height: calc(100vh - 40px);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    h1 {
      font-size: 22px;
      font-weight: 600;
      color: #1a1a1a;
      margin-bottom: 20px;
      letter-spacing: -0.02em;
    }
    
    .field {
      margin-bottom: 12px;
    }
    
    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: #6b6b6b;
      margin-bottom: 6px;
      letter-spacing: -0.01em;
    }
    
    input, select {
      width: 100%;
      padding: 10px 12px;
      font-size: 14px;
      border: 1.5px solid #e0e0e0;
      border-radius: 8px;
      background: #ffffff;
      transition: all 0.2s ease;
      font-family: inherit;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: #8b8b8b;
      box-shadow: 0 0 0 3px rgba(139, 139, 139, 0.1);
    }
    
    input:hover, select:hover {
      border-color: #c0c0c0;
    }
    
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #f0f0f0;
    }
    
    button {
      padding: 10px 16px;
      font-size: 13px;
      font-weight: 500;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      font-family: inherit;
      letter-spacing: -0.01em;
      background: #f5f5f5;
      color: #4a4a4a;
    }
    
    button:hover {
      background: #4a4a4a;
      color: white;
      border-color: #4a4a4a;
      transform: translateY(-1px);
    }
    
    .status {
      margin-top: 16px;
      padding: 12px;
      font-size: 13px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      color: #495057;
      white-space: pre-line;
    }
    
    .preview-area {
      margin-top: 20px;
      border-radius: 8px;
      border: 1px solid #e5e5e5;
      overflow-x: auto;
      overflow-y: auto;
      flex: 1;
      min-height: 200px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
      min-width: 100%;
    }
    
    th {
      background: #f8f9fa;
      color: #495057;
      font-weight: 600;
      padding: 8px 6px;
      text-align: left;
      border-bottom: 2px solid #e9ecef;
      position: sticky;
      top: 0;
      z-index: 10;
      white-space: nowrap;
      font-size: 11px;
    }
    
    td {
      padding: 6px 6px;
      border-bottom: 1px solid #f1f3f4;
      color: #2c2c2c;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
      font-size: 10px;
    }
    
    tr:hover {
      background: #fafbfc;
    }
    
    th:first-child, td:first-child {
      padding-left: 12px;
    }
    
    th:last-child, td:last-child {
      padding-right: 12px;
    }
    
    /* Specific column widths for better fit */
    th:nth-child(1), td:nth-child(1) { max-width: 100px; } /* Message ID */
    th:nth-child(2), td:nth-child(2) { max-width: 110px; } /* Timestamp */
    th:nth-child(3), td:nth-child(3) { max-width: 80px; } /* From */
    th:nth-child(4), td:nth-child(4) { max-width: 80px; } /* To */
    th:nth-child(5), td:nth-child(5) { max-width: 80px; } /* From-Process */
    th:nth-child(6), td:nth-child(6) { max-width: 60px; } /* Token Ticker */
    th:nth-child(7), td:nth-child(7) { max-width: 80px; } /* Quantity */
    th:nth-child(8), td:nth-child(8) { max-width: 50px; } /* In/Out */
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #6b6b6b;
      font-size: 14px;
    }
    
    .main-title {
      font-size: 28px;
      font-weight: 700;
      color: #1a1a1a;
      margin-bottom: 8px;
      letter-spacing: -0.03em;
    }
    
    .subtitle {
      color: #6b6b6b;
      font-size: 14px;
      margin-bottom: 24px;
    }
    
    @media (max-width: 768px) {
      .container {
        grid-template-columns: 1fr;
        gap: 16px;
        padding: 16px;
      }
      
      .sidebar {
        position: static;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="main-title">Wallet Explorer</div>
      
      <div class="field">
        <label for="wallet">Wallet Address</label>
        <input id="wallet" type="text" placeholder="Enter wallet address..."/>
      </div>

      <div class="field">
        <label for="token">Token</label>
        <select id="token">
          <option value="">All Tokens</option>
          <option value="0syT13r0s0tgPmIed95bJnuSqaD29HQNN8D3ElLSrsc">AO</option>
          <option value="qNvAoz0TgcH7DMg8BCVn8jF32QH5L6T29VjHxhHqqGE">ARIO</option>
          <option value="7zH9dlMNoxprab9loshv3Y7WG45DOny_Vrq9KrXObdQ">wUSDC</option>
          <option value="4hXj_E-5fAKmo4E8KjgQvuDJKAFk9P2grhycVmISDLs">PI</option>
          <option value="xU9zFkq3X2ZQ6olwNVvr1vUWIjc3kXTWr7xKQD6dh10">wAR</option>
          <option value="NG-0lVX882MG5nhARrSzyprEK6ejonHpdUmaaMPsHE8">qAR</option>
          <option value="FBt9A5GA_KXMMSxA2DJ0xZbAq8sLLU2ak-YJe9zDvg8">USDA</option>
          <option value="cBgS-V_yGhOe9P1wCIuNSgDA_JS8l4sE5iFcPTr0TD0">wETH</option>
          <option value="DM3FoZUq_yebASPhgd8pEIRIzDW6muXEhxz5-JwbZwo">PIXL</option>
          <option value="K59Wi9uKXBQfTn3zw7L_t-lwHAoq3Fx-V9sCyOY3dFE">SMONEY</option>
        </select>
      </div>

      <div class="field">
        <label for="action">Transfer Type</label>
        <select id="action">
          <option value="">All Transfers</option>
          <option value="Credit-Notice">Incoming Only</option>
          <option value="Debit-Notice">Outgoing Only</option>
        </select>
      </div>

      <div class="field">
        <label for="startDate">Start Date</label>
        <input id="startDate" type="date"/>
      </div>

      <div class="field">
        <label for="endDate">End Date</label>
        <input id="endDate" type="date"/>
      </div>

      <div class="button-group">
        <button id="previewBtn">Show Preview</button>
        <button id="balanceBtn">Check Balance</button>
        <button id="downloadBtn">Download CSV</button>
      </div>
    </div>

    <div class="main-content">
      <div class="main-title">Data Preview</div>
      <div class="subtitle">View wallet transactions and token balances</div>
      
      <div id="previewArea" class="preview-area"></div>
      <div class="status" id="status"></div>
    </div>
  </div>

  <script>
    const STATUS = document.getElementById("status");

    const tokenMap = {
      "0syT13r0s0tgPmIed95bJnuSqaD29HQNN8D3ElLSrsc": { ticker: "AO", factor: 1e12 },
      "qNvAoz0TgcH7DMg8BCVn8jF32QH5L6T29VjHxhHqqGE": { ticker: "ARIO", factor: 1e6 },
      "7zH9dlMNoxprab9loshv3Y7WG45DOny_Vrq9KrXObdQ": { ticker: "wUSDC", factor: 1e6 },
      "4hXj_E-5fAKmo4E8KjgQvuDJKAFk9P2grhycVmISDLs": { ticker: "PI", factor: 1e12 },
      "xU9zFkq3X2ZQ6olwNVvr1vUWIjc3kXTWr7xKQD6dh10": { ticker: "wAR", factor: 1e12 },
      "NG-0lVX882MG5nhARrSzyprEK6ejonHpdUmaaMPsHE8": { ticker: "qAR", factor: 1e12 },
      "FBt9A5GA_KXMMSxA2DJ0xZbAq8sLLU2ak-YJe9zDvg8": { ticker: "USDA", factor: 1e12 },
      "cBgS-V_yGhOe9P1wCIuNSgDA_JS8l4sE5iFcPTr0TD0": { ticker: "wETH", factor: 1e18 },
      "DM3FoZUq_yebASPhgd8pEIRIzDW6muXEhxz5-JwbZwo": { ticker: "PIXL", factor: 1e6 },
      "K59Wi9uKXBQfTn3zw7L_t-lwHAoq3Fx-V9sCyOY3dFE": { ticker: "SMONEY", factor: 1e18 },
      "8rbAftv7RaPxFjFk5FGUVAVCSjGQB4JHDcb9P9wCVhQ": { ticker: "AGENT", factor: 1e18 },
      "OsK9Vgjxo0ypX_HLz2iJJuh4hp3I80yA9KArsJjIloU": { ticker: "NAB", factor: 1e8 },
    };

    function convertQuantity(raw, fromProcessVal) {
      if (!raw) return "";
      const tokenInfo = tokenMap[fromProcessVal];
      if (!tokenInfo) return Number(raw);
      return Number(raw) / tokenInfo.factor;
    }

    function dateToEpoch(dateStr) {
      if (!dateStr) return null;
      const d = new Date(dateStr + "T00:00:00Z");
      return Math.floor(d.getTime() / 1000);
    }

    function buildQuery(wallet, fromProcess, action, cursor, startDate, endDate, pageSize=100) {
      const tagFilters = [`{ name: "Action", values: ["Debit-Notice","Credit-Notice"] }`];
      if (fromProcess) tagFilters.push(`{ name: "From-Process", values: ["${fromProcess.replace(/"/g,'\\"')}"] }`);
      if (action) tagFilters[0] = `{ name: "Action", values: ["${action}"] }`;

      let ingestedFilter = "";
      const minEpoch = dateToEpoch(startDate);
      const maxEpoch = dateToEpoch(endDate);
      if (minEpoch && maxEpoch) ingestedFilter = `ingested_at: {min: ${minEpoch}, max: ${maxEpoch}}`;
      else if (minEpoch) ingestedFilter = `ingested_at: {min: ${minEpoch}}`;
      else if (maxEpoch) ingestedFilter = `ingested_at: {max: ${maxEpoch}}`;

      return `
        query {
          transactions(
            first: ${pageSize}
            sort: HEIGHT_DESC
            recipients: ["${wallet.replace(/"/g,'\\"')}"]
            tags: [${tagFilters.join(", ")}]
            ${ingestedFilter}
            ${cursor ? `after: "${cursor}"` : ""}
          ) {
            pageInfo { hasNextPage }
            edges {
              cursor
              node {
                id
                recipient
                block { timestamp }
                tags { name value }
              }
            }
          }
        }
      `;
    }

    function csvEscape(value) {
      const s = String(value ?? "");
      if (s.includes('"') || s.includes(",") || s.includes("\n")) {
        return `"${s.replace(/"/g, '""')}"`;
      }
      return s;
    }

    function toCSV(rows) {
      const header = ["Message ID","Timestamp","From","To","From-Process","Token Ticker","Quantity","In/Out"];
      const out = [header.map(csvEscape).join(",")];
      for (const r of rows) out.push(r.map(csvEscape).join(","));
      return out.join("\n");
    }

    async function fetchTokenBalance(tokenProcess, walletAddress) {
      const payload = {
        Id: "1234",
        Target: tokenProcess,
        Owner: "1234",
        Anchor: "0",
        Data: "1234",
        Tags: [
          { name: "Action", value: "Balance" },
          { name: "Recipient", value: walletAddress },
          { name: "Data-Protocol", value: "ao" },
          { name: "Type", value: "Message" },
          { name: "Variant", value: "ao.TN.1" }
        ]
      };

      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const resp = await fetch(`https://cu.ao-testnet.xyz/dry-run?process-id=${tokenProcess}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        
        if (!resp.ok) {
          throw new Error(`HTTP ${resp.status}`);
        }
        
        const data = await resp.json();
        
        const messages = data.Messages || [];
        for (const message of messages) {
          const tags = message.Tags || [];
          const balanceTag = tags.find(tag => tag.name === "Balance");
          if (balanceTag) {
            return balanceTag.value;
          }
        }
        return "0";
      } catch (error) {
        if (error.name === 'AbortError') {
          console.error(`Timeout fetching balance for ${tokenProcess}`);
          return "Timeout";
        }
        console.error(`Error fetching balance for ${tokenProcess}:`, error);
        return "Error";
      }
    }

    async function checkBalances(walletAddress, specificToken = null) {
      STATUS.textContent = "Loading balance data...";
      const previewArea = document.getElementById("previewArea");
      previewArea.innerHTML = "";

      const tokensToCheck = specificToken ? [specificToken] : Object.keys(tokenMap);
      const balanceResults = [];

      const balancePromises = tokensToCheck.map(async (tokenProcess) => {
        const balance = await fetchTokenBalance(tokenProcess, walletAddress);
        const tokenInfo = tokenMap[tokenProcess] || {};
        const ticker = tokenInfo.ticker || "Unknown";
        const convertedBalance = convertQuantity(balance, tokenProcess);
        const roundedBalance = typeof convertedBalance === 'number' ? convertedBalance.toFixed(2) : convertedBalance;
        
        return [tokenProcess, ticker, roundedBalance];
      });

      try {
        const results = await Promise.all(balancePromises);
        balanceResults.push(...results);
      } catch (error) {
        console.error("Error fetching some balances:", error);
        STATUS.textContent = "Error fetching some balances. Check console for details.";
        return;
      }

      if (balanceResults.length === 0) {
        STATUS.textContent = "No balance data found.";
        return;
      }

      const table = renderBalanceTable(balanceResults);
      previewArea.appendChild(table);
      STATUS.textContent = `Balance check complete: ${balanceResults.length} token(s) checked.`;
    }

    function renderBalanceTable(rows) {
      const table = document.createElement("table");
      const headerRow = document.createElement("tr");
      ["Token", "Ticker", "Balance"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      rows.forEach(r => {
        const tr = document.createElement("tr");
        r.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });

      return table;
    }

    async function fetchAll(wallet, fromProcess, action, startDate, endDate) {
      let cursor = null;
      const results = [];

      while (true) {
        const query = buildQuery(wallet, fromProcess, action, cursor, startDate, endDate, 100);
        const resp = await fetch("https://arweave-search.goldsky.com/graphql", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query })
        });
        const data = await resp.json();
        const edges = data?.data?.transactions?.edges || [];
        if (!edges.length) break;

        for (const edge of edges) {
          const tx = edge.node;
          const tags = tx.tags || [];
          const get = (n) => tags.find(t => t.name === n)?.value || "";
          const fromProcessVal = get("From-Process");
          const quantityRaw = get("Quantity");
          const actionVal = get("Action");

          const tokenInfo = tokenMap[fromProcessVal] || {};
          const ticker = tokenInfo.ticker || "";
          const quantity = convertQuantity(quantityRaw, fromProcessVal);

          let ts = "";
          if (tx.block?.timestamp) {
            const d = new Date(tx.block.timestamp * 1000);
            ts = d.toLocaleString("en-US", {
              timeZone: "UTC",
              month: "2-digit", day: "2-digit", year: "numeric",
              hour: "2-digit", minute: "2-digit", second: "2-digit",
              hour12: false
            }).replace(",", "");
          }

          let from = "";
          let to = "";
          let inOut = "";
          if (actionVal === "Credit-Notice") {
            from = get("Sender");
            to = tx.recipient;
            inOut = "In";
          } else if (actionVal === "Debit-Notice") {
            from = tx.recipient;
            to = get("Recipient");
            inOut = "Out";
          }

          results.push([tx.id, ts, from, to, fromProcessVal, ticker, quantity, inOut]);
        }

        cursor = edges[edges.length - 1].cursor;
        if (!data?.data?.transactions?.pageInfo?.hasNextPage) break;
      }

      return results;
    }

    async function fetchPreview(wallet, fromProcess, action, startDate, endDate, pageSize = 20) {
      const query = buildQuery(wallet, fromProcess, action, null, startDate, endDate, pageSize);
      const resp = await fetch("https://arweave-search.goldsky.com/graphql", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      const data = await resp.json();
      const edges = data?.data?.transactions?.edges || [];
      const results = [];

      for (const edge of edges) {
        const tx = edge.node;
        const tags = tx.tags || [];
        const get = (n) => tags.find(t => t.name === n)?.value || "";
        const fromProcessVal = get("From-Process");
        const quantityRaw = get("Quantity");
        const actionVal = get("Action");

        const tokenInfo = tokenMap[fromProcessVal] || {};
        const ticker = tokenInfo.ticker || "";
        const quantity = convertQuantity(quantityRaw, fromProcessVal);

        let ts = "";
        if (tx.block?.timestamp) {
          const d = new Date(tx.block.timestamp * 1000);
          ts = d.toLocaleString("en-US", {
            timeZone: "UTC",
            month: "2-digit", day: "2-digit", year: "numeric",
            hour: "2-digit", minute: "2-digit", second: "2-digit",
            hour12: false
          }).replace(",", "");
        }

        let from = "";
        let to = "";
        let inOut = "";
        if (actionVal === "Credit-Notice") {
          from = get("Sender");
          to = tx.recipient;
          inOut = "In";
        } else if (actionVal === "Debit-Notice") {
          from = tx.recipient;
          to = get("Recipient");
          inOut = "Out";
        }

        results.push([tx.id, ts, from, to, fromProcessVal, ticker, quantity, inOut]);
      }

      return results;
    }

    function renderTable(rows) {
      const table = document.createElement("table");
      const headerRow = document.createElement("tr");
      ["Message ID","Timestamp","From","To","From-Process","Token Ticker","Quantity","In/Out"].forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        headerRow.appendChild(th);
      });
      table.appendChild(headerRow);

      rows.forEach(r => {
        const tr = document.createElement("tr");
        r.forEach(cell => {
          const td = document.createElement("td");
          td.textContent = cell;
          tr.appendChild(td);
        });
        table.appendChild(tr);
      });

      return table;
    }

    async function showPreview(wallet, fromProcess, action, startDate, endDate) {
      STATUS.textContent = "Loading data for preview...";
      const previewArea = document.getElementById("previewArea");
      previewArea.innerHTML = "";
      try {
        const rows = await fetchPreview(wallet, fromProcess || "", action || "", startDate, endDate, 20);
        if (!rows.length) {
          previewArea.innerHTML = '<div class="empty-state">No transactions found for the specified criteria.</div>';
          STATUS.textContent = "No results found.";
          return;
        }
        const table = renderTable(rows);
        previewArea.appendChild(table);
        STATUS.textContent = `Preview: ${rows.length} rows displayed.`;
      } catch (e) {
        console.error(e);
        STATUS.textContent = "Error loading preview. Details in console.";
      }
    }

    document.getElementById("previewBtn").addEventListener("click", () => {
      const wallet = document.getElementById("wallet").value.trim();
      const action = document.getElementById("action").value;
      const token = document.getElementById("token").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!wallet) { alert("Please enter a wallet address."); return; }
      showPreview(wallet, token, action, startDate, endDate);
    });

    document.getElementById("balanceBtn").addEventListener("click", () => {
      const wallet = document.getElementById("wallet").value.trim();
      const token = document.getElementById("token").value;

      if (!wallet) { alert("Please enter a wallet address."); return; }
      checkBalances(wallet, token || null);
    });

    document.getElementById("downloadBtn").addEventListener("click", async () => {
      const wallet = document.getElementById("wallet").value.trim();
      const action = document.getElementById("action").value;
      const token = document.getElementById("token").value;
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (!wallet) { alert("Please enter a wallet address."); return; }

      STATUS.textContent = "CSV is being generated...";
      try {
        const rows = await fetchAll(wallet, token, action, startDate, endDate);
        if (!rows.length) { STATUS.textContent = "No results found."; return; }
        const csvContent = toCSV(rows);
        const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `ao_transactions_${wallet}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        STATUS.textContent = `CSV successfully generated (${rows.length} rows).`;
      } catch (e) {
        console.error(e);
        STATUS.textContent = "Error generating CSV. Details in the console.";
      }
    });
  </script>
</body>
</html>
